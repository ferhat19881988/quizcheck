<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <title>Fenomen Çocuk Kulübü - Quiz Takibi</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Firebase SDK'ları -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <!-- Tema: Turuncu + Koyu/Açık Mod -->
  <style>
    :root{
      --brand-50:#fff7f0;
      --brand-100:#ffe7d4;
      --brand-200:#ffd1ad;
      --brand-300:#ffb47a;
      --brand-400:#ff9346;
      --brand-500:#ff7a1a; /* ana */
      --brand-600:#e8670e;
      --brand-700:#cc5608;
      --brand-800:#a6450b;
      --brand-900:#7a340a;

      --bs-primary: var(--brand-500);
      --bs-warning: var(--brand-400);
      --ring: rgba(255,122,26,.35);
      --card: #ffffff;
      --bg: #fffaf5;
      --text: #212529;
      --muted: #6c757d;
      --border: #ffd8b7;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --card:#141415;
        --bg:#0f0f10;
        --text:#e9ecef;
        --muted:#adb5bd;
        --border:#2a2a2b;
      }
      .navbar{
        --bs-navbar-color:#e9ecef;
      }
    }

    html,body{height:100%;}
    body{
      background: radial-gradient(1200px 800px at -10% -20%, var(--brand-50), transparent),
                  radial-gradient(1000px 600px at 110% -10%, var(--brand-100), transparent),
                  var(--bg);
      color: var(--text);
    }

    .app-card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    .section-title{
      color: var(--brand-600);
      font-weight: 700;
      letter-spacing:.2px;
    }

    /* Öğrenci grid ve kart */
    .student-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
      max-height: 420px;
      overflow: auto;
      padding-bottom: .25rem;
    }
    .student-card{
      display:flex; flex-direction:column;
      gap:.5rem;
      padding: .9rem .9rem;
      background: linear-gradient(180deg, var(--brand-50), transparent);
      border:1px solid var(--border);
      border-left: 6px solid var(--brand-400);
      border-radius: 14px;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
      cursor: pointer;
    }
    .student-card:hover{
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0,0,0,.08);
      border-color: var(--brand-500);
    }
    .student-name{
      font-weight:700;
      font-size: .98rem;
    }
    .student-name:hover{
      color: var(--brand-700);
      text-decoration: underline;
    }
    .student-info{
      font-size: .9rem;
      color: var(--muted);
    }

    /* Yapışkan aksiyon bar */
    .action-bar{
      position: sticky;
      bottom: 0;
      z-index: 5;
      background: var(--card);
      border-top: 1px solid var(--border);
      border-radius: 12px;
      padding: .5rem;
    }

    /* Form sahası */
    .form-section{
      backdrop-filter: saturate(1.15);
    }

    /* Yazdırma */
    @media print{
      body *{ visibility: hidden; }
      #print-area, #print-area *{ visibility: visible; }
      #print-area{ position:absolute; inset:0; padding:20px;}
      .no-print{ display:none !important; }
      @page{ size:A4 portrait; margin:1cm; }
    }

    /* Focus haleleri */
    .form-control:focus, .form-select:focus, .btn:focus{
      box-shadow: 0 0 0 .25rem var(--ring) !important;
      border-color: var(--brand-400) !important;
    }

    /* Yardımcı stiller */
    .brand-badge{
      background: var(--brand-100);
      color: var(--brand-800);
      border:1px solid var(--border);
    }
    .brand-logo {
  height: 40px;
  width: auto;
  border-radius: 8px;
  object-fit: contain;
}

/* Mobilde biraz küçültelim */
@media (max-width: 575.98px) {
  .brand-logo {
    height: 34px;
  }
}

  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom" style="border-color:var(--border)!important;">
  <div class="container-lg">
    <a class="navbar-brand d-flex align-items-center gap-2" href="#">
      <!-- LOGO -->
      <img src="https://i.ibb.co/cS9PSRpq/Logo-Fenomen.jpg" 
           alt="Fenomen Çocuk Kulübü" 
           class="brand-logo me-1">
      <!-- METİN -->
      <strong>Fenomen Çocuk Kulübü</strong>
    </a>
    <div class="ms-auto d-flex align-items-center gap-2">
      <span class="badge text-bg-warning-subtle border brand-badge">Quiz Takibi</span>
    </div>
  </div>
</nav>


  <!-- ANA İÇERİK -->
  <main class="container-lg my-4">
    <div class="app-card p-3 p-md-4">

      <!-- Başlık -->
      <header class="mb-3 mb-lg-4 text-center">
        <h1 class="h3 mb-1 section-title"><i class="bi bi-clipboard2-check me-1"></i>Quiz Takibi</h1>
        <p class="text-muted mb-0">Sınıf, ünite ve quiz bilgilerini gir; öğrencilerin doğru/yanlış sayılarını tek ekrandan yönet.</p>
      </header>

      <!-- Form Bölümü -->
      <section class="form-section">
        <div class="row g-3 g-md-3">
          <div class="col-12 col-md-4">
            <label for="date" class="form-label fw-semibold">Tarih</label>
            <input type="date" id="date" class="form-control" />
          </div>

          <div class="col-12 col-md-4">
            <label for="gradeLevel" class="form-label fw-semibold">Sınıf Düzeyi</label>
            <select id="gradeLevel" class="form-select">
              <option value="">-- Sınıf Seçin --</option>
              <option value="8">8. Sınıf</option>
              <option value="7">7. Sınıf</option>
              <option value="6">6. Sınıf</option>
              <option value="5">5. Sınıf</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label for="unitSelect" class="form-label fw-semibold">Ünite Seçimi</label>
            <select id="unitSelect" class="form-select">
              <option value="">-- Ünite Seçin --</option>
            </select>
          </div>

          <div class="col-12 col-lg-6">
            <label for="homework" class="form-label fw-semibold">Quiz / Ödev Adı</label>
            <textarea id="homework" rows="2" class="form-control" placeholder="Örn: 2. Ünite Hız ve Sürat - Quiz 1"></textarea>
          </div>

          <div class="col-12 col-md-6 col-lg-3">
            <label for="classSelect" class="form-label fw-semibold">Sınıf</label>
            <select id="classSelect" class="form-select">
              <option value="">-- Sınıf Seçin --</option>
            </select>
          </div>

          <div class="col-12 col-md-6 col-lg-3">
            <label for="totalQuestions" class="form-label fw-semibold">Toplam Soru</label>
            <input id="totalQuestions" type="number" min="1" value="20" class="form-control" placeholder="Örn: 20"/>
          </div>
        </div>
      </section>

      <!-- Öğrenci Grid -->
      <section class="mt-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h2 class="h6 mb-0 text-uppercase text-muted fw-semibold">Öğrenciler</h2>
          <span class="badge rounded-pill brand-badge"><i class="bi bi-people me-1"></i> Listeden seçilen sınıf</span>
        </div>
        <div id="students" class="student-grid"></div>
      </section>

      <!-- Aksiyonlar -->
      <section class="action-bar mt-3">
        <div class="row g-2">
          <div class="col-6 col-md-4 col-lg-2">
            <button class="btn btn-outline-secondary w-100" onclick="printReport()">
              <i class="bi bi-printer me-1"></i> Yazdır
            </button>
          </div>
          <div class="col-6 col-md-4 col-lg-2">
            <button class="btn btn-primary w-100" onclick="saveFormToLocalStorage()">
              <i class="bi bi-save2 me-1"></i> Kaydet
            </button>
          </div>
          <div class="col-6 col-md-4 col-lg-2">
            <button class="btn btn-outline-primary w-100" onclick="loadFormFromLocalStorage()">
              <i class="bi bi-folder2-open me-1"></i> Yükle
            </button>
          </div>
          <div class="col-6 col-md-4 col-lg-2">
            <button class="btn btn-outline-danger w-100" onclick="clearLocalStorageForm()">
              <i class="bi bi-trash3 me-1"></i> Sil
            </button>
          </div>
          <div class="col-6 col-md-4 col-lg-2">
            <button class="btn btn-warning w-100 text-dark" onclick="updateFormInLocalStorage()">
              <i class="bi bi-arrow-repeat me-1"></i> Güncelle
            </button>
          </div>
          <div class="col-6 col-md-4 col-lg-2">
            <button class="btn btn-outline-dark w-100" onclick="refreshForm()">
              <i class="bi bi-arrow-clockwise me-1"></i> Yenile
            </button>
          </div>
        </div>
      </section>

    </div>
  </main>

  <div id="print-area" style="display:none;"></div>

  <!-- GİZLİ INPUT -->
  <input type="hidden" id="currentFormKey"/>

  <!-- Firebase + Uygulama JS (orijinal mantık korunmuştur) -->
  <script>
    // Firebase yapılandırma
    const firebaseConfig = {
      apiKey: "AIzaSyAIzu6aNQstwQCdMWODyIwiaVVBm63OeGw",
      authDomain: "odevfeno.firebaseapp.com",
      databaseURL: "https://odevfeno-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "odevfeno",
      storageBucket: "odevfeno.firebasestorage.app",
      messagingSenderId: "662757516934",
      appId: "1:662757516934:web:0042188832f63deb6fd307",
      measurementId: "G-4Q99NQRB38"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    let currentFormKey = null;
    let currentDateKey = "";

    /* ============ YARDIMCI STİLLER (kısa) ============ */
    const studentData = {};
    const sınıfSet = new Set();

    /* Google Sheet -> sınıf ve öğrenciler */
    fetch("https://opensheet.elk.sh/1QYTBSXMfk4VLUYtSKchxmVWEZJ75pBy-2pIogWESoaw/Ogrenciler")
      .then(res => res.json())
      .then(data => {
        data.forEach(row => {
          const sinif = row["SINIF"];
          const ad = row["ADSOYAD"];
          if(!studentData[sinif]) studentData[sinif] = [];
          studentData[sinif].push(ad);
          sınıfSet.add(sinif);
        });

        const classSelect = document.getElementById("classSelect");
        classSelect.innerHTML = '<option value="">-- Sınıf Seçin --</option>';

        Array.from(sınıfSet)
          .sort((a,b)=>a.localeCompare(b,'tr',{numeric:true}))
          .forEach(sinif=>{
            const opt = document.createElement("option");
            opt.value = sinif; opt.textContent = sinif;
            classSelect.appendChild(opt);
          });

        if(classSelect.value){
          classSelect.dispatchEvent(new Event("change"));
        }
      })
      .catch(err=>{
        console.error("Google Sheet'ten veri alınamadı:", err);
        Swal.fire("Hata","Öğrenci listesi yüklenemedi.","error");
      });

    document.getElementById("classSelect").addEventListener("change", function(){
      const selectedClass = this.value;
      const container = document.getElementById("students");
      container.innerHTML = "";

      const totalQuestionsInput = document.getElementById("totalQuestions");
      let totalQuestions = parseInt(totalQuestionsInput.value) || 0;

      if(!studentData[selectedClass]) return;

      studentData[selectedClass]
        .slice()
        .sort((a,b)=>a.localeCompare(b,'tr',{sensitivity:'base'}))
        .forEach(name=>{
          const div = document.createElement("div");
          div.className = "student-card";
          div.innerHTML = `
            <span class="student-name" onclick="openStudentModal('${name}')">▪ ${name}</span>
            <div class="d-flex align-items-center gap-2">
              <input type="number" class="form-control form-control-sm wrong-count" min="0" placeholder="Yanlış sayısı" style="max-width: 150px;">
              <button class="btn btn-sm btn-success whatsapp-btn"><i class="bi bi-whatsapp"></i></button>
            </div>
            <div class="student-info"></div>
          `;

          const wrongInput = div.querySelector(".wrong-count");
          const infoDiv = div.querySelector(".student-info");
          const btn = div.querySelector(".whatsapp-btn");

          function updateInfo(){
            totalQuestions = parseInt(totalQuestionsInput.value) || 0;
            const wrong = parseInt(wrongInput.value) || 0;
            const correct = Math.max(0, totalQuestions - wrong);
            const percent = totalQuestions>0 ? Math.round((correct/totalQuestions)*100) : 0;

            infoDiv.innerHTML = `
              <div class="d-flex align-items-center justify-content-between">
                <span>📘 ${totalQuestions} sorudan <strong>${correct}</strong> doğru</span>
                <span class="badge rounded-pill text-bg-warning border brand-badge">🎯 %${percent}</span>
              </div>
              <div class="progress mt-1" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${percent}">
                <div class="progress-bar" style="width:${percent}%"></div>
              </div>
            `;
          }

          wrongInput.addEventListener("input", updateInfo);
          totalQuestionsInput.addEventListener("input", ()=>{
            const wrong = parseInt(wrongInput.value);
            if(!isNaN(wrong)) updateInfo();
          });

          btn.addEventListener("click", ()=>{
            const wrong = parseInt(wrongInput.value) || 0;
            const correct = Math.max(0, totalQuestions - wrong);
            const percent = totalQuestions>0 ? Math.round((correct/totalQuestions)*100) : 0;
            generateWhatsappLink(name, correct, wrong, percent);
          });

          container.appendChild(div);
        });
    });

    /* Yazdırma (görsel düzen korunur) */
    function printReport(){
      const rawDate = document.getElementById("date").value;
      const dateParts = rawDate.split("-");
      const dateFormatted = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
      const grade = document.getElementById("gradeLevel").value;
      const unit = document.getElementById("unitSelect").value;
      const quiz = document.getElementById("homework").value;
      const selectedClass = document.getElementById("classSelect").value;
      const totalQuestions = parseInt(document.getElementById("totalQuestions").value);
      const students = document.querySelectorAll(".student-card");

      if(!rawDate || !grade || !unit || !quiz || !selectedClass || !totalQuestions){
        Swal.fire("Uyarı","Lütfen tüm alanları doldurunuz.","warning");
        return;
      }
      if(students.length===0){
        Swal.fire("Hata","Hiç öğrenci bulunamadı.","error");
        return;
      }

      let tableRows = "";
      let includedCount = 0;

      students.forEach(card=>{
        const name = card.querySelector(".student-name").innerText.replace("▪ ","");
        const wrong = parseInt(card.querySelector(".wrong-count").value);
        if(isNaN(wrong)) return;
        const correct = Math.max(0, totalQuestions - wrong);
        const percent = totalQuestions>0 ? Math.round((correct/totalQuestions)*100) : 0;

        tableRows += `<tr>
          <td>${name}</td>
          <td>${correct}</td>
          <td>${wrong}</td>
          <td>%${percent}</td>
        </tr>`;
        includedCount++;
      });

      if(includedCount===0){
        Swal.fire("Uyarı","Hiçbir öğrenci için yanlış sayısı girilmemiş.","info");
        return;
      }

      const printContent = `
  <html>
  <head>
    <title>Quiz Raporu - ${dateFormatted} - ${selectedClass} - ${unit}</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Quicksand', sans-serif; margin:20px; background:#fffdf9; color:#333; }
      h1 { color:#e65c00; text-align:center; font-size:26px; margin-bottom:0; }
      .subtitle { text-align:center; font-size:16px; color:#666; margin:0 0 20px 0; }
      .info-box{ display:flex; justify-content:center; flex-wrap:wrap; gap:20px; margin-bottom:20px; font-size:15px; }
      .info-box div{ background:#fff1e6; padding:10px 16px; border-radius:12px; border:1px solid #ffc98b; box-shadow:0 1px 4px rgba(0,0,0,0.05); min-width:220px; text-align:center; }
      table{ width:100%; border-collapse:collapse; font-size:14px; margin-top:10px; }
      th,td{ border:1px solid #aaa; padding:10px; text-align:center; }
      th{ background:#ffe0cc; font-weight:600; }
      tr:nth-child(even){ background-color:#fdf4eb; }
      .icon-label{ font-weight:600; color:#e65c00; }
    </style>
  </head>
  <body>
    <h1>Fenomen Çocuk Kulübü - Quiz Takibi</h1>
    <div class="subtitle">📘 Fen Bilimleri &nbsp;&nbsp;&nbsp; 👨‍🏫 Öğretmen: Ferhat Karagöz</div>
    <div class="info-box">
      <div><span class="icon-label">📅 Tarih:</span><br>${dateFormatted}</div>
      <div><span class="icon-label">🏫 Sınıf:</span><br>${selectedClass}</div>
      <div><span class="icon-label">📚 Konu:</span><br>${unit}</div>
      <div><span class="icon-label">📝 Quiz:</span><br>${quiz}</div>
      <div><span class="icon-label">❓ Toplam Soru:</span><br>${totalQuestions}</div>
    </div>
    <table>
      <tr><th>👤 Öğrenci</th><th>✅ Doğru</th><th>❌ Yanlış</th><th>🎯 Başarı (%)</th></tr>
      ${tableRows}
    </table>
    <p style="margin-top:15px; font-style:italic; font-size:13px; color:#666; text-align:center;">* Bu raporda yalnızca sınava girmiş öğrenciler listelenmiştir.</p>
  </body></html>`;

      const win = window.open('', '_blank');
      win.document.open(); win.document.write(printContent); win.document.close();
      win.focus(); win.onload = ()=> win.print();
    }

    /* Ünite havuzu */
    const allUnits = {
      turkce:{ "5":["Sözcükte Anlam","Cümlede Anlam","Paragrafta Anlam","Dil Bilgisi","Yazım Kuralları","Noktalama İşaretleri","Metin Türleri","Anlatım Bozuklukları"],
               "6":["Sözcükte Anlam","Cümlede Anlam","Paragraf Yorumu","Fiil, Zarf, Sıfat","Yazım ve Noktalama","Paragraf Çözümleme","Metin Yapısı","Deyim ve Atasözleri"],
               "7":["Sözcükte Anlam","Paragraf Bilgisi","Cümlede Anlam","Dil Bilgisi","Yazılı Anlatım","Metin Türleri","Anlatım Bozuklukları"],
               "8":["Sözcükte ve Cümlede Anlam","Paragraf Bilgisi","Dil Bilgisi","Metin Türleri","Yazım ve Noktalama","Anlatım Bozuklukları"] },
      matematik:{ "5":["Doğal Sayılar","Kesirler","Ondalık Sayılar","Geometri","Veri ve İstatistik","Zaman","Örüntüler ve Süreçler"],
                  "6":["Tam Sayılar","Kesirler ve Ondalıklar","Oran ve Orantı","Cebirsel İfadeler","Geometrik Cisimler","Veri ve Olasılık"],
                  "7":["Tam Sayılar","Rasyonel Sayılar","Denklemler","Oran ve Orantı","Geometrik Cisimler","Açılar ve Çokgenler","Veri Yorumlama"],
                  "8":["Çarpanlar ve Katlar","Üslü Sayılar","Kareköklü İfadeler","Denklemler","Eşitsizlikler","Geometrik Cisimler","Olasılık","Eşlik ve Benzerlik"] },
      fen:{ "5":["Güneş, Dünya ve Ay","Kuvvet ve Hareket","Maddeyi Tanıyalım","Işık ve Ses","Canlılar Dünyası","Elektrik ve Enerji"],
            "6":["Destek ve Hareket Sistemi","Sindirim – Dolaşım – Solunum","Kuvvet – Sürat","Yoğunluk – Isı – Hal Değişimi","Ses","Elektrik ve Yaşam"],
            "7":["Güneş Sistemi","Hücre ve Bölünmeler","Kuvvet – Enerji","Madde ve Karışımlar","Işık – Ses","Canlılarda Enerji","Elektrik Devreleri"],
            "8":["Mevsimler ve İklim","DNA ve Genetik Kod","Basınç","Madde ve Endüstri","Basit Makineler","Enerji Dönüşümleri","Elektrik Yükleri"] },
      sosyal:{ "5":["Birlikte Yaşama","Kültürel Miras","İnsanlar, Yerler ve Çevreler","Üretim, Dağıtım, Tüketim","Birey ve Toplum","Bilim, Teknoloji, Toplum"],
               "6":["Zaman ve Mekan","Kültür ve Miras","İnsanlar ve Yerler","Bilim – Teknoloji – Toplum","Ekonomi – Kaynaklar","Demokrasi ve Yurttaşlık"],
               "7":["Kültür ve Miras","İnsanlar ve Yerler","Bilimsel Gelişmeler","Ekonomi ve Kaynaklar","Vatandaşlık ve Haklar","Küresel Bağlantılar"],
               "8":["İnkılap Tarihi","Kurtuluş Savaşı","Cumhuriyet Dönemi","Demokrasi Kültürü","Toplum ve Değerler"] },
      ingilizce:{ "5":["Hello!","My Town","Games and Hobbies","Health","The Animal Shelter","My Daily Routine","My House","My Clothes"],
                  "6":["Life","Weather","Occupations","Downtown","Holidays","Environment","Bookworms","Democracy"],
                  "7":["Appearance","Sports","Biographies","Movies and Media","Environment","Celebrations","Dreams","Jobs and Future"],
                  "8":["Friendship","Teen Life","In the Kitchen","On the Phone","The Internet","Adventures","Tourism","Science"] },
      din:{ "5":["İslam'ın Temel İnançları","Peygamberimiz ve Ailesi","İbadetler","Ahlak ve Değerler","Kuran’dan Mesajlar"],
            "6":["Allah İnancı","Peygamberler ve Dualar","İbadet Bilinci","İslam Ahlakı","Toplumsal Sorumluluk"],
            "7":["İnanç ve İbadet","Peygamberimizin Hayatı","Kur'an ve Mesajları","Ahlak ve Davranış","Din Kültürü"],
            "8":["İslam’da Kader","İslam’da Sosyal Adalet","Zekât ve Sadaka","Hz. Muhammed’in Örnekliği","Kur'an’ın Özellikleri"] }
    };

    window.onload = function(){
      document.getElementById("date").addEventListener("change", ()=> generateDateKey(false));
      document.getElementById("classSelect").addEventListener("change", ()=> generateDateKey(false));
      document.getElementById("homework").addEventListener("input", ()=> generateDateKey(false));
    };

    function generateWhatsappLink(name, correct, wrong, percentage){
      const rawDate = document.getElementById("date").value;
      const quiz = document.getElementById("homework").value;
      const unit = document.getElementById("unitSelect").value;

      if(!rawDate || !quiz || !unit){
        Swal.fire({ icon:'warning', title:'Eksik Alan!', text:'Tarih, quiz adı ve ünite bilgileri doldurulmalıdır.', confirmButtonText:'Tamam' });
        return;
      }

      const dateParts = rawDate.split("-");
      const formattedDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;

      const message = `📘 *Ders:* Fen Bilimleri
👨‍🏫 *Öğretmen:* Ferhat Karagöz
🎓 *Öğrenci:* *${name}*
📅 *Tarih:* ${formattedDate}
📝 *Quiz:* ${quiz}
📚 *Konu:* ${unit}

✅ *Doğru:* ${correct}
❌ *Yanlış:* ${wrong}
🎯 *Başarı Oranı:* %${percentage}

📌 Bu bilgilendirme, *Fenomen Çocuk Kulübü* tarafından iletilmektedir.`;

      const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(url,'_blank');
    }

    function updateUnitOptions(){
      const grade = document.getElementById("gradeLevel").value;
      const unitSelect = document.getElementById("unitSelect");
      unitSelect.innerHTML = '<option value="">-- Ünite Seçin --</option>';
      if(grade && allUnits.fen[grade]){
        allUnits.fen[grade].forEach(unit=>{
          const opt = document.createElement("option");
          opt.value = unit; opt.textContent = unit;
          unitSelect.appendChild(opt);
        });
      }
    }
    document.getElementById("gradeLevel").addEventListener("change", updateUnitOptions);

    function saveFormToLocalStorage(){
      generateDateKey(true);
      const currentKey = currentDateKey;
      if(!currentKey) return;

      const date = document.getElementById("date").value;
      const grade = document.getElementById("gradeLevel").value;
      const unit = document.getElementById("unitSelect").value;
      const quiz = document.getElementById("homework").value.trim();
      const selectedClass = document.getElementById("classSelect").value;
      const totalQuestions = parseInt(document.getElementById("totalQuestions").value);

      if(!date || !grade || !unit || !quiz || !selectedClass || !totalQuestions){
        Swal.fire("Eksik Bilgi","Lütfen tüm alanları doldurunuz.","warning"); return;
      }

      const students = Array.from(document.querySelectorAll(".student-card"))
        .map(card=>{
          const name = card.querySelector(".student-name").innerText.replace("▪ ","");
          const wrongStr = card.querySelector(".wrong-count").value.trim();
          if(wrongStr==="") return null;
          const wrong = parseInt(wrongStr);
          if(isNaN(wrong)) return null;
          const correct = Math.max(0, totalQuestions - wrong);
          const percentage = totalQuestions>0 ? Math.round((correct/totalQuestions)*100) : 0;
          return { name, wrong, correct, total: totalQuestions, percentage };
        })
        .filter(s=>s!==null);

      const formData = { date, grade, unit, quiz, class: selectedClass, students };

      database.ref('forms/'+currentKey).set(formData)
        .then(()=> Swal.fire("Başarılı", `"${quiz}" quiz kaydı başarıyla Firebase'e yüklendi.`, "success"))
        .catch(error=>{
          console.error("Firebase kayıt hatası:", error);
          Swal.fire("Hata","Firebase'e kayıt başarısız. Lütfen bağlantıyı kontrol edin.","error");
        });
    }

    function loadFormFromLocalStorage(){
      database.ref('forms').once('value')
        .then(snapshot=>{
          const data = snapshot.val();
          if(!data){ Swal.fire("Kayıt Bulunamadı","Firebase'de kayıtlı form yok.","info"); return; }

          const quizForms = Object.fromEntries(Object.entries(data).filter(([key])=> key.startsWith("Quiz - ")));
          if(Object.keys(quizForms).length===0){ Swal.fire("Kayıt Bulunamadı","Hiçbir quiz kaydı bulunamadı.","info"); return; }
         const keys = Object.keys(quizForms)
  .sort((a, b) => {
    const dateA = new Date(quizForms[a].date);
    const dateB = new Date(quizForms[b].date);
    return dateB - dateA; // büyükten küçüğe -> en yeni başta
  });

          Swal.fire({
            title:"Yüklenecek Quiz Kaydı Seçin",
            input:"select",
            inputOptions: keys.reduce((o,k)=> (o[k]=k,o),{}),
            inputPlaceholder:"Kayıt seçin",
            showCancelButton:true,
            confirmButtonText:"Yükle",
            cancelButtonText:"İptal",
            customClass:{ popup:'wide-popup', input:'centered-select' }
          }).then(result=>{
            if(result.isConfirmed){
              const selectedKey = result.value;
              currentFormKey = selectedKey;
              const formData = quizForms[selectedKey];

              document.getElementById("date").value = formData.date;
              document.getElementById("classSelect").value = formData.class;
              document.getElementById("gradeLevel").value = formData.grade;
              document.getElementById("homework").value = formData.quiz;

              updateUnitOptions();
              setTimeout(()=>{ document.getElementById("unitSelect").value = formData.unit; },100);

              document.getElementById("totalQuestions").value = formData.students?.[0]?.total || "";
              document.getElementById("classSelect").dispatchEvent(new Event("change"));

              setTimeout(()=>{
                const cards = document.querySelectorAll(".student-card");
                const notFoundStudents = [];
                formData.students.forEach(savedStudent=>{
                  const match = Array.from(cards).find(card =>
                    card.querySelector(".student-name").innerText.replace("▪ ","") === savedStudent.name
                  );
                  if(match){
                    match.querySelector(".wrong-count").value = savedStudent.wrong;
                    match.querySelector(".wrong-count").dispatchEvent(new Event("input"));
                  }else{
                    notFoundStudents.push(savedStudent.name);
                  }
                });

                if(notFoundStudents.length>0){
                  const count = notFoundStudents.length;
                  let msg = "";
                  if(count===1){
                    msg = `<strong>${notFoundStudents[0]}</strong> adlı öğrenci listede bulunamadı.`;
                  }else if(count===2){
                    msg = `<strong>${notFoundStudents[0]}</strong> ve <strong>${notFoundStudents[1]}</strong> adlı iki öğrenci listede bulunamadı.`;
                  }else{
                    msg = `Aşağıdaki <strong>${count}</strong> öğrenci listede bulunamadı:
                    <ul style="text-align:left; font-size:14px; margin-top:10px;">
                      ${notFoundStudents.map(n=>`<li>▪ ${n}</li>`).join('')}
                    </ul>`;
                  }
                  Swal.fire({ icon:"warning", title:"Yükleme Uyarısı", html:msg, confirmButtonText:"Tamam" });
                }
              },150);
            }
          });
        })
        .catch(error=>{
          console.error("Yükleme hatası:", error);
          Swal.fire("Hata","Veri yüklenemedi.","error");
        });
    }

    function clearLocalStorageForm(){
      database.ref('forms').once('value')
        .then(snapshot=>{
          const data = snapshot.val();
          if(!data){ Swal.fire({icon:'info', title:"Kayıt Yok", text:"Silinecek quiz kaydı bulunamadı.", confirmButtonText:"Tamam"}); return; }

          const quizKeys = Object.keys(data)
  .filter(key => key.startsWith("Quiz - "))
  .sort((a, b) => {
    const dateA = new Date(data[a].date);
    const dateB = new Date(data[b].date);
    return dateB - dateA; // büyükten küçüğe -> en yeni başta
  });
          if(quizKeys.length===0){ Swal.fire({icon:'info', title:"Kayıt Yok", text:"Silinecek herhangi bir Quiz kaydı bulunamadı.", confirmButtonText:"Tamam"}); return; }

          Swal.fire({
            title:"Silinecek Quiz kaydını seçin",
            input:"select",
            inputOptions: quizKeys.reduce((o,k)=> (o[k]=k,o),{}),
            inputPlaceholder:"Quiz kaydı seçin",
            showCancelButton:true,
            confirmButtonText:"Sil",
            cancelButtonText:"İptal",
            showDenyButton:true,
            denyButtonText:"🧨 Tüm Kayıtları Sil"
          }).then(result=>{
            if(result.isConfirmed){
              const selectedKey = result.value;
              database.ref('forms/'+selectedKey).remove()
                .then(()=> Swal.fire({icon:'success', title:"Silindi", text:`"${selectedKey}" quiz kaydı silindi.`}))
                .catch(error=>{
                  console.error("Silme hatası:", error);
                  Swal.fire("Hata","Quiz kaydı silinirken bir hata oluştu.","error");
                });
            }else if(result.isDenied){
              Swal.fire({
                icon:'warning', title:'Emin misiniz?', text:'Tüm kayıtlar silinecek!',
                showCancelButton:true, confirmButtonText:'Evet, Hepsini Sil', cancelButtonText:'Vazgeç'
              }).then(confirmResult=>{
                if(confirmResult.isConfirmed){
                  const updates = {};
                  quizKeys.forEach(key=> updates[`forms/${key}`]=null );
                  database.ref().update(updates)
                    .then(()=> Swal.fire({icon:'success', title:"Tüm Quiz Kayıtları Silindi", text:`${quizKeys.length} kayıt başarıyla silindi.`}))
                    .catch(error=>{
                      console.error("Toplu silme hatası:", error);
                      Swal.fire("Hata","Toplu silme başarısız.","error");
                    });
                }
              });
            }
          });
        })
        .catch(error=>{
          console.error("Veri okuma hatası:", error);
          Swal.fire("Hata","Kayıtlar okunamadı.","error");
        });
    }

    function updateFormInLocalStorage(){
      if(!currentFormKey || !currentFormKey.startsWith("Quiz - ")){
        Swal.fire("Hata","Güncellenebilecek geçerli bir quiz kaydı yok.","error"); return;
      }
      const date = document.getElementById("date").value;
      const grade = document.getElementById("gradeLevel").value;
      const unit = document.getElementById("unitSelect").value;
      const quiz = document.getElementById("homework").value.trim();
      const selectedClass = document.getElementById("classSelect").value;
      const totalQuestions = parseInt(document.getElementById("totalQuestions").value);

      if(!date || !grade || !unit || !quiz || !selectedClass || !totalQuestions){
        Swal.fire("Eksik Bilgi","Lütfen tüm alanları doldurunuz.","warning"); return;
      }

      const students = Array.from(document.querySelectorAll(".student-card"))
        .map(card=>{
          const name = card.querySelector(".student-name").innerText.replace("▪ ","");
          const wrongStr = card.querySelector(".wrong-count").value.trim();
          if(wrongStr==="") return null;
          const wrong = parseInt(wrongStr);
          if(isNaN(wrong)) return null;
          const correct = Math.max(0, totalQuestions - wrong);
          const percentage = totalQuestions>0 ? Math.round((correct/totalQuestions)*100) : 0;
          return { name, wrong, correct, total: totalQuestions, percentage };
        })
        .filter(s=>s!==null);

      const formData = { date, grade, unit, quiz, class: selectedClass, students };

      database.ref('forms/'+currentFormKey).set(formData)
        .then(()=> Swal.fire("Güncellendi", `"${quiz}" quiz kaydı başarıyla güncellendi.`, "success"))
        .catch(error=>{
          console.error("Firebase güncelleme hatası:", error);
          Swal.fire("Hata","Firebase'e güncelleme yapılamadı.","error");
        });
    }

    function sanitizeKeyPart(str){
      return String(str||"").replace(/[.#$/\[\]]/g,"-").replace(/\s+/g," ").trim();
    }

    function generateDateKey(showAlert=false){
      const raw = document.getElementById("date").value;
      const date = raw.includes("T") ? raw.split("T")[0] : raw;
      const selectedClass = document.getElementById("classSelect").value;
      const quiz = document.getElementById("homework").value.trim();
      const unit = document.getElementById("unitSelect").value;

      if(!date || !selectedClass || !quiz || !unit){
        currentDateKey = "";
        if(showAlert){ Swal.fire("Eksik Bilgi","Tarih, sınıf, quiz adı ve ünite boş bırakılamaz.","warning"); }
        return;
      }

      const sanitize = s => String(s||"").replace(/[.#$/\[\]]/g,"-").replace(/\s+/g," ").trim();
      const keyDate = sanitize(date);
      const keyClass = sanitize(selectedClass);
      const keyQuiz  = sanitize(quiz);
      const keyUnit  = sanitize(unit);
      const randomId = Math.random().toString(36).substring(2,6);

      currentDateKey = `Quiz - ${keyDate} - ${keyClass} - ${keyUnit} - ${keyQuiz} - ${randomId}`;
    }

    function openStudentModal(studentName){
      const oneMonthAgo = new Date();
      oneMonthAgo.setMonth(oneMonthAgo.getMonth()-1);

      database.ref('forms').once('value')
        .then(snapshot=>{
          const allForms = snapshot.val();
          if(!allForms){ Swal.fire("Veri Yok","Hiçbir quiz kaydı bulunamadı.","info"); return; }

          const quizForms = Object.entries(allForms).filter(([key])=> key.startsWith("Quiz - "));
          const reports = [];

          quizForms.forEach(([key,data])=>{
            const formDate = new Date(data.date);
            if(isNaN(formDate.getTime()) || formDate < oneMonthAgo) return;
            const match = data.students?.find(s=> s.name===studentName);
            if(!match) return;

            const day = formDate.getDate().toString().padStart(2,'0');
            const month = (formDate.getMonth()+1).toString().padStart(2,'0');
            const year = formDate.getFullYear().toString().slice(2);
            const formattedDate = `${day}.${month}.${year}`;
            const percentage = Math.round(match.percentage);
            const quizName = data.quiz || "-";
            const unit = data.unit || "-";

            reports.push({ date:formattedDate, quiz:quizName, unit, correct:match.correct, wrong:match.wrong, percentage });
          });

          if(reports.length===0){
            Swal.fire({ icon:"info", title:"Veri Bulunamadı", text:`${studentName} adlı öğrenciye ait son 1 aya dair kayıtlı quiz verisi bulunamadı.`, confirmButtonText:"Tamam" });
            return;
          }

          reports.sort((a,b)=> new Date(b.date.split('.').reverse().join('-')) - new Date(a.date.split('.').reverse().join('-')));
          const average = Math.round(reports.reduce((sum,r)=> sum+r.percentage,0)/reports.length);

          const lines = reports.map(r=>(`• ${r.date}
📚 *Konu:* ${r.unit}
📝 *Quiz:* ${r.quiz}
✅ *Doğru:* ${r.correct} | ❌ *Yanlış:* ${r.wrong}
🎯 *Başarı:* %${r.percentage}\n`));

          const msg = `📘 *Ders:* Fen Bilimleri
👨‍🏫 *Öğretmen:* Ferhat Karagöz
🎓 *Öğrenci:* *${studentName}*
🗓️ *Dönem:* Son 1 Ay

📚 *Quiz Katılım Raporu:*  

${lines.join('\n')}
📊 *Toplam Quiz:* ${reports.length}
📈 *Ortalama Başarı:* %${average}

📌 Bu rapor, *Fenomen Çocuk Kulübü* tarafından iletilmektedir.`;

          Swal.fire({
            title: studentName,
            html: `<pre style="text-align:left;white-space:pre-wrap;font-size:13px;padding:10px 0;margin:0">${msg}</pre>`,
            showCancelButton: true,
            confirmButtonText: '📤 WhatsApp Gönder',
            cancelButtonText: 'Kapat',
            customClass: { popup: 'wide-popup' }
          }).then(result=>{
            if(result.isConfirmed){
              const whatsappURL = `https://wa.me/?text=${encodeURIComponent(msg)}`;
              window.open(whatsappURL,'_blank');
            }
          });
        })
        .catch(error=>{
          console.error("openStudentModal hata:", error);
          Swal.fire("Hata","Veriler alınamadı.","error");
        });
    }

    function refreshForm(){
      document.getElementById("date").value = "";
      document.getElementById("gradeLevel").value = "";
      document.getElementById("unitSelect").innerHTML = '<option value="">-- Ünite Seçin --</option>';
      document.getElementById("homework").value = "";
      document.getElementById("classSelect").value = "";
      document.getElementById("students").innerHTML = "";
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
